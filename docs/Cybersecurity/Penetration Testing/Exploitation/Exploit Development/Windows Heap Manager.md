## General Information

- https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/-address
- https://illmatics.com/XP2003_Exploitation.pdf
- https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex
- https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualfreeex
- https://docs.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapalloc
- https://docs.microsoft.com/en-gb/windows/win32/api/heapapi/nf-heapapi-heapfree
- https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-rtlallocateheap
- https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-rtlfreeheap
- https://docs.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapcreate
- https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-rtlcreateheap
- http://support.tenasys.com/INtimeHelp_62/ovw_heaps.html


To understand what heap memory is, we need to first take a look at the Heap Manager.

This is a software layer that resides on top of the virtual memory interfaces provided by the Windows operating system.

This software layer allows applications to dynamically request and release memory through a set of Windows APIs (`VirtualAllocEx`, `VirtualFreeEx`, `HeapAlloc`, and `HeapFree`). 

These APIs will eventually call into their respective native functions in `ntdll.dll` (`RtlAllocateHeap` and `RtlFreeHeap`).

In Windows operating systems, when a process starts, the Heap Manager automatically creates a new heap called the default process heap. 

At a very high level, heaps are big chunks of memory that are divided into smaller pieces to fulfill dynamic memory allocation requests.

Although some processes only use the default process heap, many will create additional heaps using the `HeapCreate` API (or its lower-level interface `ntdll!RtlCreateHeap`) to isolate different components running in the process itself.

Other processes make substantial use of the C Runtime heap for most dynamic allocations (`malloc` / free functions). 
These heap implementations, defined as NT Heap, eventually make use of the Windows Heap Manager functions in `ntdll.dll` to interface with the kernel Windows Virtual Memory Manager and to allocate memory dynamically.


## Heap Memory

Each program is provided with a default process heap, but a process may optionally allocate any number of additional heaps, if more storage is needed. 

The heap functions will manage their virtual memory usage automatically, and therefore heaps can be set to grow if they are being filled up with data. 
If a heap is allowed to grow automatically, the heap functions will automatically allocate additional pages as needed. 
On the x86 architecture the heap grows in size towards higher memory addresses.

To use heap memory, a heap must first be allocated (or a handle must be obtained to the default heap). 
Once you have obtained a handle to a heap, you can pass that handle to the memory allocation functions, to allocate memory from that particular heap.

The `stdlib` memory functions (`malloc`, `realloc`, `calloc`, `free`) are all used very similarly to the heap functions, so programmers familiar with the `stdlib` functions may be able to figure out what many of the heap functions are doing, by examining their names:

- `HeapCreate` - allocates a heap, and returns a handle to that heap. All the other heap functions will use this handle to uniquely identify the particular heap that you are accessing. By maintaining multiple handles, your program may interface with multiple separate heaps.
- `HeapDestroy` - this function closes a heap handle, and deallocates the heap memory so that other processes can use it.
- `GetProcessHeap` - this function returns a handle to the default process heap. Each program gets a default heap when it is loaded, and in most applications this should be enough space to store data items.
- `HeapAlloc` - similar to the `STDLIB` `malloc` function, `HeapAllo`c allocates storage space on the heap, and returns a pointer to that space.
- `HeapReAlloc` - similar to the `STDLIB` `realloc` function, `HeapReAlloc` reallocates the storage space of a variable to be a different size.
- `HeapFree` - frees a memory object on the heap. Attempts to use the same pointer to access memory after it has been freed will cause an error.


