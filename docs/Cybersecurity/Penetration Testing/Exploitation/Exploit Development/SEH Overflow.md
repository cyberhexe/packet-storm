## General Information

- https://msdn.microsoft.com/en-us/library/windows/desktop/ms680657(v=vs.85).aspx
- https://docs.microsoft.com/en-us/archive/blogs/davidklinems/what-is-a-first-chance-exception

Exceptions are unexpected events that occur during normal program execution. 

There are two kinds of exceptions:

- hardware exceptions
- software exceptions

Hardware exceptions are initiated by the CPU. 
We encountered a typical hardware exception when our script crashed the Sync Breeze service as the CPU attempted to dereference an invalid memory address.

On the other hand, software exceptions are explicitly initiated by applications when the execution flow reaches unexpected or unwanted conditions. 
For example, a software developer might want to raise an exception in their code to signal that a function could not execute normally because of an invalid input argument.

At a high level, the SEH mechanism (which is implemented in the operating system) gives developers an opportunity to take action when an unexpected event happens during the execution of a thread. 

More specifically, when a thread faults, the operating system calls a designated set of functions (known as exception handlers), which can correct, or provide more information about, the unexpected condition. 
The exception handlers are user-defined and are created during the compilation of the previously mentioned `_except` code blocks.

The operating system must be able to locate the correct exception handler when an unexpected event is encountered.

## Understanding SEH

- https://en.wikipedia.org/wiki/Win32_Thread_Information_Block
- https://docs.microsoft.com/en-us/cpp/c-runtime-library/except-handler3?view=msvc-160

To understand how this happens, it's important to know that structured exception handling works on a per-thread level. 
Additionally, each thread in a program can be identified by the Thread Environmental Block (TEB) structure, which stores important information related to the respective thread.

Every time a try block is encountered during the execution of a function in a thread, a pointer to the corresponding exception handler is saved on the stack within the `_EXCEPTION_REGISTRATION_RECORD` structure. 
Since there may be several try blocks executed in a function, these structures are connected together in a linked list.


When an exception occurs, the operating system inspects the `TEB` structure of the faulting thread and retrieves a pointer (`ExceptionList`) to the linked list of `_EXCEPTION_REGISTRATION_RECORD` structures through the `FS` CPU register.
The CPU can access the `TEB` structure at any given time using the `FS` segment register at offset zero (`fs:[0]`) on the x86 architecture.

After retrieving the `ExceptionList`, the operating system will begin to walk it and invoke every exception handler function until one is able to deal with the unexpected event. 
If none of the user-defined functions can handle the exception, the operating system invokes the default exception handler, which is always the last node in the linked list. 
As previously mentioned, this is a special exception handler that terminates the current process or thread in case the application is a system service.


## SEH Validation

- https://hackmag.com/uncategorized/exceptions-for-hardcore-users/
- https://msrc-blog.microsoft.com/2009/02/02/preventing-the-exploitation-of-structured-exception-handler-seh-overwrites-with-sehop/
- https://docs.microsoft.com/en-us/cpp/build/reference/safeseh-image-has-safe-exception-handlers?view=msvc-170

When an exception is encountered, `ntdll!KiUserExceptionDispatcher` is called. 
This function is responsible for dispatching exceptions on Windows operating systems. The function takes two arguments. The first is an `_EXCEPTION_RECORD` structure that contains information about the exception.
The second argument is a `CONTEXT` structure.
Eventually, this function calls into `RtlDispatchException`, which will retrieve the `TEB` and proceed to parse the `ExceptionList` through the mechanism explained in the previous section.

During this process, for each `Handler` member in the singly-linked `ExceptionList` list, the operating system will ensure that the `_EXCEPTION_REGISTRATION_RECORD` structure falls within the stack memory limits found in the `TEB`. Furthermore, during the execution of `RtlDispatchException`, the operating system performs additional checks by invoking the `RtlIsValidHandler` function for every exception handler.

`RtlIsValidHandler` is responsible for the `SafeSEH` implementation. This is a mitigation introduced by Microsoft to prevent an attacker from gaining control of the execution flow after overwriting a stack-based exception handler.

At a high level, if a module is compiled with the SafeSEH flag, the linker will produce an image containing a table of safe exception handlers.

## Bypassing Stack Cookies

With the increase in stack overflows Microsoft included a stack overflow mitigation named `GS` which is enabled by default in modern versions of Visual Studio.

At a high level, when a binary that is compiled with the `/GS` flag is loaded a random stack cookie seed value is initialized and stored in the `.data` section of the binary. 
When a function protected by `GS` is called, an `XOR` operation takes place between the stack cookie seed value and the `EBP` register.

The result of this operation is stored on the stack prior to the return address.

Before returning out of the protected function, another `XOR` operation occurs between the previous value saved on the stack and the `EBP` register. 
This result is then checked with the stack cookie seed value from the .data section.
If the values do not match the application will throw an exception and terminate the execution.

Overwriting an exception handler and causing the application to crash in any way triggers the `SEH` mechanism and causes the instruction pointer to be redirected to the address of the `exception_handler` prior to reaching the end of the vulnerable function. 
Because of this increasing the size of a stack overflow and overwriting a `_EXCEPTION_REGISTRATION_RECORD` can allow an attacker to bypass stack cookies.



